<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>番茄钟</title>
    <link rel="stylesheet" type="text/css" href="./css/iview.css">
    <script type="text/javascript" src="./js/vue.js"></script>
    <script type="text/javascript" src="./js/iview.min.js"></script>
    <style>
      .center {
        display: flex;
        justify-content: center;
      }
    </style>
</head>
<body>
<div id="app">
  <row type="flex" justify="center">
    <i-col span="12" class="center">
      <i-circle
        :percent="percent"
        :stroke-color="progress === 'work' ? '#2D8CF0' : '#5cb85c'"
        :size="180"
        :trail-width="4"
        :stroke-width="5"
      >
        <span>{{ clock }}</span>
      </i-circle> 
    </i-col>
  </row>
  <row type="flex" justify="center">
    <i-col span="12" class="center" :style="{ paddingTop: '10px' }">
      <i-button v-on:click.prevent="changeStatus('play')" v-if="status == 'stop' && progress == 'work'">开始专注</i-button>
      <i-button v-on:click.prevent="changeStatus('stop')" v-else-if="status == 'play' && progress == 'work'">放弃番茄</i-button>
      <i-button v-else v-on:click.prevent="changeStatus('play')">休息结束</i-button>
    </i-col>
  </row>
  <row type="flex" justify="center">
    <i-col span="12" :style="{ paddingTop: '10px' }">
      <span>今日完成番茄数：{{ completedPomodoro }}</span>
    </i-col>
  </row>
</div>
<script>
  window.vm = new Vue({
    el: '#app',
    data: {
      status: "stop", // stop, play
      progress: 'work', // work, rest
      timer: 0,
      startAt: 0, // 校准timer
      elapsed: 0,
      completedPomodoro: 0,
      showDate: new Date(),
      duration: {
        work: 15,
        rest: 3,
      },
      rest: {
        short: 300,
        long: 1500,
      },
    },
    mounted: function() {
      this.timer = this.duration.work;
    },
    computed: {
      clock: function() {
        const min = Math.floor(this.timer / 60);
        const sec = this.timer % 60;
        return (min > 9 ? min : `0${min}`) + ':' + (sec > 9 ? sec : `0${sec}`); 
      },
      percent: function() {
        return this.timer / this.duration[this.progress] * 100;
      }
    },
    methods: {
      changeStatus: function(status) {
        this.status = status;
        this.timer = this.duration.work;
        if (status === 'play') {
          this.progress = 'work';
          this.startAt = Date.now()
          this.changeTimer();
        } else {
          this.startAt = 0;
          this.elapsed = 0;
        }
      },
      changeTimer: function() {
        setTimeout(() => {

          if (this.timer === 0) {
            if (this.progress === 'work') {
              this.progress = 'rest';
              this.startAt = Date.now();
              setPomodoroData();
              this.completedPomodoro = getPomodoroData(new Date());
              if (this.completedPomodoro % 4 === 0) {
                this.duration.rest = this.rest.long;
              } else {
                this.duration.rest = this.rest.short;
              }
              this.timer = this.duration.rest;
              showNotification('你已完成一个番茄时间，休息一下吧:)');
              this.completedPomodoro = getPomodoroData(new Date());
            } else {
              this.progress = 'work';
              this.startAt = Date.now();
              this.timer = this.duration.work;
              showNotification('开始专注地工作吧，加油:)');
              notification.onclick = () => notification.close();
              ;
            }
          }
          if (this.status === 'play') {
            this.timer -- ;
             this.elapsed = (Date.now() - this.startAt) - (this.duration[this.progress] - this.timer) * 1000;
            this.changeTimer();
          }
        }, 1000 - this.elapsed);
      },
    }    
  });
</script>
</body>
</html>